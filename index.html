<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dados GBP</title>
  <!-- Vari√°veis de ambiente injetadas pela Vercel (veja _middleware.js) -->
  <meta name="fb-api-key"       content="__FIREBASE_API_KEY__">
  <meta name="fb-auth-domain"   content="__FIREBASE_AUTH_DOMAIN__">
  <meta name="fb-project-id"    content="__FIREBASE_PROJECT_ID__">
  <meta name="fb-storage-bucket" content="__FIREBASE_STORAGE_BUCKET__">
  <meta name="fb-sender-id"     content="__FIREBASE_MESSAGING_SENDER_ID__">
  <meta name="fb-app-id"        content="__FIREBASE_APP_ID__">
  <meta name="admin-email"      content="__ADMIN_EMAIL__">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0f1e;
      --surface: #111827;
      --surface2: #1a2235;
      --border: #1e2d45;
      --accent: #00e5ff;
      --accent2: #7c3aed;
      --green: #10b981;
      --red: #ef4444;
      --yellow: #f59e0b;
      --text: #e2e8f0;
      --muted: #64748b;
      --font-display: 'Syne', sans-serif;
      --font-body: 'DM Sans', sans-serif;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: var(--bg); color: var(--text); font-family: var(--font-body); min-height: 100vh; }

    /* LOGIN */
    #login-screen { min-height:100vh; display:flex; align-items:center; justify-content:center; background:var(--bg); position:relative; }
    .login-bg { position:absolute; inset:0; background: radial-gradient(ellipse 80% 60% at 20% 50%, rgba(0,229,255,0.07) 0%, transparent 60%), radial-gradient(ellipse 60% 80% at 80% 30%, rgba(124,58,237,0.08) 0%, transparent 60%); pointer-events:none; }
    .login-card { background:var(--surface); border:1px solid var(--border); border-radius:20px; padding:48px 40px; width:100%; max-width:420px; position:relative; z-index:1; box-shadow:0 0 80px rgba(0,229,255,0.05), 0 40px 80px rgba(0,0,0,0.4); }
    .login-logo { font-family:var(--font-display); font-size:28px; font-weight:800; letter-spacing:-1px; margin-bottom:8px; }
    .login-logo span { color:var(--accent); }
    .login-subtitle { color:var(--muted); font-size:14px; margin-bottom:36px; }
    .form-group { margin-bottom:20px; }
    .form-group label { display:block; font-size:12px; font-weight:500; text-transform:uppercase; letter-spacing:0.08em; color:var(--muted); margin-bottom:8px; }
    .form-group input { width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:10px; padding:12px 16px; color:var(--text); font-family:var(--font-body); font-size:15px; outline:none; transition:border-color 0.2s; }
    .form-group input:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(0,229,255,0.1); }
    .btn-primary { width:100%; background:var(--accent); color:#0a0f1e; border:none; border-radius:10px; padding:14px; font-family:var(--font-display); font-size:15px; font-weight:700; cursor:pointer; transition:all 0.2s; margin-top:8px; }
    .btn-primary:hover { background:#33ecff; transform:translateY(-1px); }
    .error-msg { color:var(--red); font-size:13px; margin-top:12px; text-align:center; display:none; }

    /* APP */
    #app { display:none; }
    .sidebar { position:fixed; left:0; top:0; bottom:0; width:240px; background:var(--surface); border-right:1px solid var(--border); display:flex; flex-direction:column; padding:28px 20px; z-index:100; }
    .sidebar-logo { font-family:var(--font-display); font-size:20px; font-weight:800; letter-spacing:-0.5px; padding:0 8px; margin-bottom:32px; }
    .sidebar-logo span { color:var(--accent); }
    .nav-section { font-size:10px; text-transform:uppercase; letter-spacing:0.12em; color:var(--muted); padding:0 8px; margin-bottom:8px; margin-top:16px; }
    .nav-item { display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; cursor:pointer; font-size:14px; font-weight:500; color:var(--muted); transition:all 0.15s; margin-bottom:2px; }
    .nav-item:hover { background:var(--surface2); color:var(--text); }
    .nav-item.active { background:rgba(0,229,255,0.1); color:var(--accent); }
    .nav-item .icon { font-size:18px; width:20px; text-align:center; }
    .sidebar-bottom { margin-top:auto; border-top:1px solid var(--border); padding-top:16px; }
    .user-chip { display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; background:var(--surface2); }
    .user-avatar { width:32px; height:32px; background:linear-gradient(135deg, var(--accent), var(--accent2)); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:700; color:#fff; flex-shrink:0; }
    .user-info { flex:1; min-width:0; }
    .user-name { font-size:13px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .user-role { font-size:11px; color:var(--muted); }
    .btn-logout { background:none; border:none; color:var(--muted); cursor:pointer; font-size:18px; padding:4px; transition:color 0.15s; }
    .btn-logout:hover { color:var(--red); }

    /* MAIN */
    .main { margin-left:240px; padding:32px 36px; min-height:100vh; }
    .page { display:none; }
    .page.active { display:block; animation: fadeUp 0.3s ease; }
    @keyframes fadeUp { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:translateY(0); } }
    .page-header { margin-bottom:28px; }
    .page-title { font-family:var(--font-display); font-size:28px; font-weight:800; letter-spacing:-0.5px; }
    .page-subtitle { color:var(--muted); font-size:14px; margin-top:4px; }

    /* CARDS */
    .cards-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:16px; margin-bottom:24px; }
    .card { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:20px; position:relative; overflow:hidden; }
    .card::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; }
    .card.cyan::before { background:var(--accent); }
    .card.purple::before { background:var(--accent2); }
    .card.green::before { background:var(--green); }
    .card.yellow::before { background:var(--yellow); }
    .card.red::before { background:var(--red); }
    .card-label { font-size:11px; text-transform:uppercase; letter-spacing:0.1em; color:var(--muted); margin-bottom:10px; }
    .card-value { font-family:var(--font-display); font-size:32px; font-weight:800; letter-spacing:-1px; }
    .card-delta { font-size:12px; margin-top:6px; }
    .delta-up { color:var(--green); }
    .delta-down { color:var(--red); }

    /* TABLE */
    .table-card { background:var(--surface); border:1px solid var(--border); border-radius:16px; overflow:hidden; margin-bottom:24px; }
    .table-header { padding:20px 24px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
    .table-title { font-family:var(--font-display); font-size:16px; font-weight:700; }
    table { width:100%; border-collapse:collapse; }
    th { text-align:left; font-size:11px; text-transform:uppercase; letter-spacing:0.1em; color:var(--muted); padding:12px 24px; border-bottom:1px solid var(--border); font-weight:500; }
    td { padding:14px 24px; font-size:14px; border-bottom:1px solid rgba(30,45,69,0.5); }
    tr:last-child td { border-bottom:none; }
    tr:hover td { background:rgba(255,255,255,0.02); }

    /* BADGES */
    .badge { display:inline-flex; align-items:center; gap:5px; padding:3px 10px; border-radius:100px; font-size:12px; font-weight:500; }
    .badge-green { background:rgba(16,185,129,0.12); color:var(--green); }
    .badge-red { background:rgba(239,68,68,0.12); color:var(--red); }
    .badge-yellow { background:rgba(245,158,11,0.12); color:var(--yellow); }
    .badge-cyan { background:rgba(0,229,255,0.1); color:var(--accent); }
    .stars { color:var(--yellow); font-size:14px; }

    /* ALERTS */
    .alert-item { display:flex; align-items:flex-start; gap:14px; padding:16px 24px; border-bottom:1px solid rgba(30,45,69,0.5); }
    .alert-item:last-child { border-bottom:none; }
    .alert-icon { width:36px; height:36px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0; }
    .alert-icon.red { background:rgba(239,68,68,0.12); }
    .alert-icon.yellow { background:rgba(245,158,11,0.12); }
    .alert-icon.cyan { background:rgba(0,229,255,0.1); }
    .alert-text { flex:1; }
    .alert-title { font-size:14px; font-weight:500; margin-bottom:2px; }
    .alert-desc { font-size:13px; color:var(--muted); }
    .alert-time { font-size:12px; color:var(--muted); white-space:nowrap; }

    /* CLIENTS */
    .clients-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:16px; }
    .client-card { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:20px; cursor:pointer; transition:all 0.2s; }
    .client-card:hover { border-color:var(--accent); box-shadow:0 0 30px rgba(0,229,255,0.08); transform:translateY(-2px); }
    .client-name { font-family:var(--font-display); font-size:16px; font-weight:700; margin-bottom:4px; }
    .client-company { font-size:13px; color:var(--muted); margin-bottom:16px; }
    .client-stats { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; }
    .client-stat { text-align:center; }
    .client-stat-value { font-family:var(--font-display); font-size:20px; font-weight:800; }
    .client-stat-label { font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:0.08em; }

    /* EMPTY */
    .empty-state { text-align:center; padding:60px 20px; color:var(--muted); }
    .empty-icon { font-size:48px; margin-bottom:12px; }
    .empty-title { font-family:var(--font-display); font-size:18px; font-weight:700; color:var(--text); margin-bottom:6px; }
    .empty-desc { font-size:14px; }

    /* MODAL */
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:1000; display:none; align-items:center; justify-content:center; backdrop-filter:blur(4px); }
    .modal-overlay.open { display:flex; }
    .modal { background:var(--surface); border:1px solid var(--border); border-radius:20px; padding:32px; width:100%; max-width:480px; max-height:90vh; overflow-y:auto; }
    .modal-title { font-family:var(--font-display); font-size:20px; font-weight:800; margin-bottom:24px; }
    .modal-footer { display:flex; gap:12px; margin-top:24px; }
    .btn-secondary { flex:1; background:var(--surface2); border:1px solid var(--border); border-radius:10px; padding:12px; color:var(--text); font-family:var(--font-body); font-size:14px; cursor:pointer; transition:all 0.15s; }
    .btn-secondary:hover { background:var(--border); }
    .btn-success { flex:1; background:var(--accent); border:none; border-radius:10px; padding:12px; color:#0a0f1e; font-family:var(--font-display); font-size:14px; font-weight:700; cursor:pointer; transition:all 0.15s; }
    .btn-success:hover { background:#33ecff; }

    /* TOAST */
    .toast { position:fixed; bottom:24px; right:24px; background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:14px 20px; font-size:14px; display:flex; align-items:center; gap:10px; z-index:9999; transform:translateY(100px); opacity:0; transition:all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); max-width:340px; box-shadow:0 8px 32px rgba(0,0,0,0.3); }
    .toast.show { transform:translateY(0); opacity:1; }
    .toast.success { border-color:rgba(16,185,129,0.4); }
    .toast.error { border-color:rgba(239,68,68,0.4); }

    /* MISC */
    .spinner { width:20px; height:20px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 0.6s linear infinite; display:inline-block; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .response-box { background:var(--surface2); border:1px solid var(--border); border-radius:12px; padding:16px; font-size:14px; line-height:1.6; color:var(--text); margin-top:12px; }
    .response-label { font-size:11px; text-transform:uppercase; letter-spacing:0.1em; color:var(--accent); margin-bottom:8px; font-weight:600; }
    ::-webkit-scrollbar { width:6px; }
    ::-webkit-scrollbar-track { background:var(--bg); }
    ::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-bg"></div>
  <div class="login-card">
    <div class="login-logo">Dados <span>GBP</span></div>
    <div class="login-subtitle">Painel de gest√£o do Google Business Profile</div>
    <div class="form-group">
      <label>E-mail</label>
      <input type="email" id="login-email" placeholder="seu@email.com" />
    </div>
    <div class="form-group">
      <label>Senha</label>
      <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
    </div>
    <button class="btn-primary" onclick="handleLogin()">Entrar</button>
    <div class="error-msg" id="login-error">E-mail ou senha incorretos.</div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <aside class="sidebar">
    <div class="sidebar-logo">Dados <span>GBP</span></div>
    <div id="nav-client">
      <div class="nav-section">Vis√£o geral</div>
      <div class="nav-item active" onclick="showPage('dashboard', this)"><span class="icon">üìä</span> Dashboard</div>
      <div class="nav-item" onclick="showPage('avaliacoes', this)"><span class="icon">‚≠ê</span> Avalia√ß√µes</div>
      <div class="nav-item" onclick="showPage('alertas', this)">
        <span class="icon">üîî</span> Alertas
        <span id="alert-badge" style="margin-left:auto;background:var(--red);color:#fff;font-size:11px;padding:1px 7px;border-radius:100px;display:none;"></span>
      </div>
    </div>
    <div id="nav-admin" style="display:none;">
      <div class="nav-section">Administra√ß√£o</div>
      <div class="nav-item" onclick="showPage('admin-clientes', this)"><span class="icon">üë•</span> Clientes</div>
      <div class="nav-item" onclick="showPage('admin-alertas', this)"><span class="icon">üö®</span> Todos os Alertas</div>
    </div>
    <div class="sidebar-bottom">
      <div class="user-chip">
        <div class="user-avatar" id="user-avatar">?</div>
        <div class="user-info">
          <div class="user-name" id="user-name">Carregando...</div>
          <div class="user-role" id="user-role">‚Äî</div>
        </div>
        <button class="btn-logout" onclick="handleLogout()" title="Sair">‚Ü™</button>
      </div>
    </div>
  </aside>

  <main class="main">
    <!-- DASHBOARD -->
    <div id="page-dashboard" class="page active">
      <div class="page-header">
        <div class="page-title" id="dash-title">Dashboard</div>
        <div class="page-subtitle" id="dash-subtitle">Vis√£o geral do desempenho</div>
      </div>
      <div class="cards-grid">
        <div class="card cyan"><div class="card-label">Visualiza√ß√µes (30d)</div><div class="card-value" id="stat-views">‚Äî</div><div class="card-delta" id="stat-views-delta">carregando...</div></div>
        <div class="card purple"><div class="card-label">Cliques no Site</div><div class="card-value" id="stat-clicks">‚Äî</div><div class="card-delta" id="stat-clicks-delta">carregando...</div></div>
        <div class="card green"><div class="card-label">Nota M√©dia</div><div class="card-value" id="stat-rating">‚Äî</div><div class="card-delta">estrelas</div></div>
        <div class="card yellow"><div class="card-label">Total Avalia√ß√µes</div><div class="card-value" id="stat-reviews">‚Äî</div><div class="card-delta" id="stat-reviews-delta">carregando...</div></div>
        <div class="card red"><div class="card-label">Liga√ß√µes (30d)</div><div class="card-value" id="stat-calls">‚Äî</div><div class="card-delta" id="stat-calls-delta">carregando...</div></div>
      </div>
      <div class="table-card">
        <div class="table-header"><div class="table-title">√öltimas Avalia√ß√µes</div></div>
        <div id="dash-reviews-list"><div class="empty-state"><div class="spinner"></div><div style="margin-top:12px;color:var(--muted)">Carregando...</div></div></div>
      </div>
    </div>

    <!-- AVALIA√á√ïES -->
    <div id="page-avaliacoes" class="page">
      <div class="page-header">
        <div class="page-title">Avalia√ß√µes</div>
        <div class="page-subtitle">Todas as avalia√ß√µes do seu perfil Google</div>
      </div>
      <div class="table-card">
        <div class="table-header"><div class="table-title">Hist√≥rico</div><span id="reviews-count" class="badge badge-cyan">0</span></div>
        <div id="reviews-list"><div class="empty-state"><div class="spinner"></div></div></div>
      </div>
    </div>

    <!-- ALERTAS -->
    <div id="page-alertas" class="page">
      <div class="page-header">
        <div class="page-title">Alertas</div>
        <div class="page-subtitle">Notifica√ß√µes importantes sobre seu perfil</div>
      </div>
      <div class="table-card">
        <div class="table-header"><div class="table-title">Alertas Recentes</div></div>
        <div id="alertas-list"><div class="empty-state"><div class="spinner"></div></div></div>
      </div>
    </div>

    <!-- ADMIN CLIENTES -->
    <div id="page-admin-clientes" class="page">
      <div class="page-header" style="display:flex;align-items:center;justify-content:space-between;">
        <div><div class="page-title">Clientes</div><div class="page-subtitle">Gerencie todos os seus clientes</div></div>
        <button class="btn-primary" style="width:auto;padding:10px 20px;" onclick="openAddClientModal()">+ Novo Cliente</button>
      </div>
      <div class="clients-grid" id="clients-grid"><div class="empty-state" style="grid-column:1/-1"><div class="spinner"></div></div></div>
    </div>

    <!-- ADMIN ALERTAS -->
    <div id="page-admin-alertas" class="page">
      <div class="page-header"><div class="page-title">Todos os Alertas</div><div class="page-subtitle">Alertas de todos os clientes</div></div>
      <div class="table-card">
        <div class="table-header"><div class="table-title">Central de Alertas</div></div>
        <div id="all-alertas-list"><div class="empty-state"><div class="spinner"></div></div></div>
      </div>
    </div>
  </main>
</div>

<!-- MODAL: NOVO CLIENTE -->
<div class="modal-overlay" id="modal-add-client">
  <div class="modal">
    <div class="modal-title">Novo Cliente</div>
    <div class="form-group"><label>Nome do cliente</label><input type="text" id="new-client-name" placeholder="Jo√£o Silva" /></div>
    <div class="form-group"><label>Nome da empresa</label><input type="text" id="new-client-company" placeholder="Restaurante do Jo√£o" /></div>
    <div class="form-group"><label>E-mail de acesso</label><input type="email" id="new-client-email" placeholder="joao@email.com" /></div>
    <div class="form-group"><label>Senha inicial</label><input type="text" id="new-client-password" placeholder="M√≠nimo 6 caracteres" /></div>
    <div class="form-group"><label>WhatsApp (com DDD)</label><input type="text" id="new-client-whatsapp" placeholder="51999998888" /></div>
    <div class="form-group"><label>Location ID do GBP</label><input type="text" id="new-client-location" placeholder="locations/1234567890" /></div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeModal('modal-add-client')">Cancelar</button>
      <button class="btn-success" onclick="addClient()">Criar Cliente</button>
    </div>
  </div>
</div>

<!-- MODAL: AVALIA√á√ÉO -->
<div class="modal-overlay" id="modal-review">
  <div class="modal">
    <div class="modal-title">Avalia√ß√£o</div>
    <div id="modal-review-content"></div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeModal('modal-review')">Fechar</button>
      <button class="btn-success" onclick="copyResponse()">Copiar Resposta</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, orderBy, limit, Timestamp } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-firestore.js";

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üîß CONFIGURA√á√ÉO ‚Äî carregada do servidor via /api/config
  // As chaves ficam nas vari√°veis de ambiente da Vercel (nunca no c√≥digo)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  let ADMIN_EMAIL = '';
  let auth, db;

  async function initApp() {
    try {
      const res = await fetch('/api/config');
      const cfg = await res.json();
      ADMIN_EMAIL = cfg.adminEmail || '';

      const firebaseConfig = {
        apiKey: cfg.apiKey, authDomain: cfg.authDomain,
        projectId: cfg.projectId, storageBucket: cfg.storageBucket,
        messagingSenderId: cfg.messagingSenderId, appId: cfg.appId,
      };

      const app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db   = getFirestore(app);

      onAuthStateChanged(auth, async (user) => {
        if (user) { await loadUserData(user); showApp(); }
        else { showLogin(); }
      });
    } catch(e) {
      const err = document.getElementById('login-error');
      err.textContent = 'Erro de configura√ß√£o. Contate o administrador.';
      err.style.display = 'block';
    }
  }

  initApp();

  let currentUserData = null;

  async function loadUserData(user) {
    const isAdmin = user.email === ADMIN_EMAIL;
    if (isAdmin) {
      currentUserData = { nome: 'Administrador', role: 'admin', email: user.email };
      document.getElementById('nav-admin').style.display = 'block';
      document.getElementById('user-role').textContent = 'Administrador';
      loadAdminDashboard();
    } else {
      const q = query(collection(db, 'clientes'), where('email', '==', user.email));
      const snap = await getDocs(q);
      if (!snap.empty) {
        currentUserData = { id: snap.docs[0].id, ...snap.docs[0].data(), role: 'cliente' };
        document.getElementById('user-role').textContent = currentUserData.empresa || 'Cliente';
        loadClientDashboard(currentUserData);
      }
    }
    const initials = (currentUserData?.nome || user.email).slice(0,2).toUpperCase();
    document.getElementById('user-avatar').textContent = initials;
    document.getElementById('user-name').textContent = currentUserData?.nome || user.email;
  }

  window.handleLogin = async function() {
    const email = document.getElementById('login-email').value;
    const pass  = document.getElementById('login-password').value;
    const err   = document.getElementById('login-error');
    err.style.display = 'none';
    try { await signInWithEmailAndPassword(auth, email, pass); }
    catch(e) { err.style.display = 'block'; }
  };

  window.handleLogout = async function() { await signOut(auth); };

  function showLogin() {
    document.getElementById('login-screen').style.display = 'flex';
    document.getElementById('app').style.display = 'none';
  }
  function showApp() {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
  }

  window.showPage = function(page, el) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('page-' + page).classList.add('active');
    if (el) el.classList.add('active');
    if (page === 'avaliacoes')     loadReviewsPage();
    if (page === 'alertas')        loadAlertasPage();
    if (page === 'admin-clientes') loadAdminClientes();
    if (page === 'admin-alertas')  loadAllAlertas();
  };

  // ‚îÄ‚îÄ DASHBOARD CLIENTE ‚îÄ‚îÄ
  async function loadClientDashboard(c) {
    document.getElementById('dash-title').textContent = c.empresa || 'Dashboard';
    document.getElementById('dash-subtitle').textContent = 'Desempenho dos √∫ltimos 30 dias';

    const mq = query(collection(db,'metricas'), where('clienteId','==',c.id), orderBy('data','desc'), limit(1));
    const mSnap = await getDocs(mq);
    if (!mSnap.empty) {
      const m = mSnap.docs[0].data();
      document.getElementById('stat-views').textContent  = (m.visualizacoes||0).toLocaleString('pt-BR');
      document.getElementById('stat-clicks').textContent = (m.cliquessite||0).toLocaleString('pt-BR');
      document.getElementById('stat-calls').textContent  = (m.ligacoes||0).toLocaleString('pt-BR');
    } else {
      ['stat-views','stat-clicks','stat-calls'].forEach(id => document.getElementById(id).textContent = '‚Äî');
    }

    const rq = query(collection(db,'avaliacoes'), where('clienteId','==',c.id), orderBy('data','desc'), limit(5));
    const rSnap = await getDocs(rq);
    let total = 0, count = 0;
    const reviews = [];
    rSnap.forEach(d => { const r = {id:d.id,...d.data()}; reviews.push(r); total += r.nota||0; count++; });
    document.getElementById('stat-reviews').textContent = count;
    document.getElementById('stat-rating').textContent  = count > 0 ? (total/count).toFixed(1) : '‚Äî';

    const container = document.getElementById('dash-reviews-list');
    if (!reviews.length) {
      container.innerHTML = `<div class="empty-state"><div class="empty-icon">‚≠ê</div><div class="empty-title">Nenhuma avalia√ß√£o ainda</div></div>`;
    } else {
      container.innerHTML = `<table><thead><tr><th>Cliente</th><th>Nota</th><th>Coment√°rio</th><th>Data</th><th></th></tr></thead><tbody>${reviews.map(r=>`
        <tr>
          <td><strong>${r.autor||'An√¥nimo'}</strong></td>
          <td>${starsHtml(r.nota)}</td>
          <td style="max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${r.comentario||'<em style="color:var(--muted)">Sem coment√°rio</em>'}</td>
          <td style="color:var(--muted)">${formatDate(r.data)}</td>
          <td><button onclick='openReviewModal(${JSON.stringify(r)})' style="background:rgba(0,229,255,0.1);border:none;color:var(--accent);padding:5px 12px;border-radius:6px;cursor:pointer;font-size:12px">‚ú® Responder</button></td>
        </tr>`).join('')}</tbody></table>`;
    }

    const aq = query(collection(db,'alertas'), where('clienteId','==',c.id), where('lido','==',false));
    const aSnap = await getDocs(aq);
    if (aSnap.size > 0) {
      const b = document.getElementById('alert-badge');
      b.textContent = aSnap.size; b.style.display = 'inline-block';
    }
  }

  // ‚îÄ‚îÄ AVALIA√á√ïES ‚îÄ‚îÄ
  async function loadReviewsPage() {
    if (!currentUserData) return;
    const rq = query(collection(db,'avaliacoes'), where('clienteId','==',currentUserData.id), orderBy('data','desc'));
    const snap = await getDocs(rq);
    const reviews = snap.docs.map(d=>({id:d.id,...d.data()}));
    document.getElementById('reviews-count').textContent = `${reviews.length} avalia√ß√µes`;
    const container = document.getElementById('reviews-list');
    if (!reviews.length) {
      container.innerHTML = `<div class="empty-state"><div class="empty-icon">‚≠ê</div><div class="empty-title">Nenhuma avalia√ß√£o</div></div>`;
    } else {
      container.innerHTML = `<table><thead><tr><th>Cliente</th><th>Nota</th><th>Coment√°rio</th><th>Data</th><th></th></tr></thead><tbody>${reviews.map(r=>`
        <tr>
          <td><strong>${r.autor||'An√¥nimo'}</strong></td>
          <td>${starsHtml(r.nota)}</td>
          <td style="max-width:300px">${r.comentario||'<em style="color:var(--muted)">Sem coment√°rio</em>'}</td>
          <td style="color:var(--muted)">${formatDate(r.data)}</td>
          <td><button onclick='openReviewModal(${JSON.stringify(r)})' style="background:rgba(0,229,255,0.1);border:none;color:var(--accent);padding:5px 12px;border-radius:6px;cursor:pointer;font-size:12px">‚ú® IA</button></td>
        </tr>`).join('')}</tbody></table>`;
    }
  }

  // ‚îÄ‚îÄ ALERTAS ‚îÄ‚îÄ
  async function loadAlertasPage() {
    if (!currentUserData) return;
    const aq = query(collection(db,'alertas'), where('clienteId','==',currentUserData.id), orderBy('data','desc'));
    const snap = await getDocs(aq);
    const alertas = snap.docs.map(d=>({id:d.id,...d.data()}));
    const container = document.getElementById('alertas-list');
    container.innerHTML = alertas.length ? alertas.map(a=>alertItemHtml(a)).join('') :
      `<div class="empty-state"><div class="empty-icon">üéâ</div><div class="empty-title">Tudo certo!</div><div class="empty-desc">Nenhum alerta no momento</div></div>`;
  }

  // ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ
  async function loadAdminDashboard() {
    document.getElementById('dash-title').textContent = 'Painel Administrativo';
    document.getElementById('dash-subtitle').textContent = 'Vis√£o geral de todos os clientes';
    const snap = await getDocs(collection(db,'clientes'));
    document.getElementById('stat-views').textContent = snap.size;
    document.getElementById('stat-views-delta').textContent = 'clientes ativos';
    const aq = query(collection(db,'alertas'), where('lido','==',false));
    const aSnap = await getDocs(aq);
    document.getElementById('stat-calls').textContent = aSnap.size;
    document.getElementById('stat-calls-delta').textContent = 'alertas pendentes';
    document.getElementById('dash-reviews-list').innerHTML = `<div class="empty-state"><div class="empty-icon">üëÜ</div><div class="empty-title">Use o menu lateral</div><div class="empty-desc">Acesse "Clientes" para ver detalhes de cada um</div></div>`;
  }

  async function loadAdminClientes() {
    const snap = await getDocs(collection(db,'clientes'));
    const clientes = snap.docs.map(d=>({id:d.id,...d.data()}));
    const grid = document.getElementById('clients-grid');
    grid.innerHTML = clientes.length ? clientes.map(c=>`
      <div class="client-card">
        <div class="client-name">${c.nome}</div>
        <div class="client-company">${c.empresa||'‚Äî'}</div>
        <div class="client-stats">
          <div class="client-stat"><div class="client-stat-value" style="color:var(--accent)">${c.totalAvaliacoes||0}</div><div class="client-stat-label">Avalia√ß√µes</div></div>
          <div class="client-stat"><div class="client-stat-value" style="color:var(--yellow)">${c.notaMedia||'‚Äî'}</div><div class="client-stat-label">Nota</div></div>
          <div class="client-stat"><div class="client-stat-value" style="color:var(--red)">${c.alertasAbertos||0}</div><div class="client-stat-label">Alertas</div></div>
        </div>
      </div>`).join('') :
      `<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">üë•</div><div class="empty-title">Nenhum cliente ainda</div><div class="empty-desc">Clique em "+ Novo Cliente" para come√ßar</div></div>`;
  }

  async function loadAllAlertas() {
    const snap = await getDocs(query(collection(db,'alertas'), orderBy('data','desc')));
    const alertas = snap.docs.map(d=>({id:d.id,...d.data()}));
    const container = document.getElementById('all-alertas-list');
    container.innerHTML = alertas.length ? alertas.map(a=>alertItemHtml(a,true)).join('') :
      `<div class="empty-state"><div class="empty-icon">üéâ</div><div class="empty-title">Sem alertas</div></div>`;
  }

  // ‚îÄ‚îÄ NOVO CLIENTE ‚îÄ‚îÄ
  window.openAddClientModal = function() { document.getElementById('modal-add-client').classList.add('open'); };
  window.addClient = async function() {
    const nome      = document.getElementById('new-client-name').value.trim();
    const empresa   = document.getElementById('new-client-company').value.trim();
    const email     = document.getElementById('new-client-email').value.trim();
    const password  = document.getElementById('new-client-password').value.trim();
    const whatsapp  = document.getElementById('new-client-whatsapp').value.trim();
    const locationId= document.getElementById('new-client-location').value.trim();
    if (!nome||!email||!password) { showToast('Preencha nome, e-mail e senha','error'); return; }
    try {
      await addDoc(collection(db,'clientes'), { nome, empresa, email, whatsapp, locationId, dataCriacao: Timestamp.now(), totalAvaliacoes:0, notaMedia:0, alertasAbertos:0 });
      closeModal('modal-add-client');
      showToast(`‚úÖ ${nome} adicionado! Crie o login no Firebase Auth.`,'success');
      loadAdminClientes();
    } catch(e) { showToast('Erro: '+e.message,'error'); }
  };

  // ‚îÄ‚îÄ MODAL AVALIA√á√ÉO + IA ‚îÄ‚îÄ
  window.openReviewModal = function(review) {
    if (typeof review === 'string') review = JSON.parse(review);
    const empresa = currentUserData?.empresa || 'nossa empresa';
    document.getElementById('modal-review-content').innerHTML = `
      <div style="margin-bottom:16px">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
          <div style="width:40px;height:40px;background:var(--surface2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px">üë§</div>
          <div><div style="font-weight:600">${review.autor||'An√¥nimo'}</div><div>${starsHtml(review.nota)} <span style="color:var(--muted);font-size:12px">${formatDate(review.data)}</span></div></div>
        </div>
        <p style="font-size:14px;color:var(--muted);line-height:1.6">${review.comentario||'Sem coment√°rio'}</p>
      </div>
      <div class="response-label">‚ú® Sugest√£o de resposta (IA)</div>
      <div class="response-box" id="ai-suggestion"><div style="display:flex;align-items:center;gap:8px;color:var(--muted)"><div class="spinner"></div> Gerando sugest√£o...</div></div>`;
    document.getElementById('modal-review').classList.add('open');
    generateAISuggestion(review, empresa);
  };

  async function generateAISuggestion(review, empresa) {
    const el = document.getElementById('ai-suggestion');
    try {
      // Chama nossa API route segura no Vercel (n√£o exp√µe a chave)
      const res = await fetch('/api/suggest', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ review, empresa })
      });
      const data = await res.json();
      el.textContent = data.suggestion || 'N√£o foi poss√≠vel gerar sugest√£o.';
      el.setAttribute('data-suggestion', data.suggestion || '');
    } catch(e) {
      el.textContent = 'Erro ao gerar sugest√£o.';
    }
  }

  window.copyResponse = function() {
    const el = document.getElementById('ai-suggestion');
    const text = el.getAttribute('data-suggestion') || el.textContent;
    navigator.clipboard.writeText(text).then(()=>showToast('‚úÖ Copiado!','success'));
  };

  window.closeModal = function(id) { document.getElementById(id).classList.remove('open'); };

  window.showToast = function(msg, type='success') {
    const t = document.getElementById('toast');
    t.textContent = msg; t.className = `toast ${type} show`;
    setTimeout(()=>t.classList.remove('show'), 3500);
  };

  function starsHtml(n) { n=parseInt(n)||0; return `<span class="stars">${'‚òÖ'.repeat(n)}${'‚òÜ'.repeat(5-n)}</span>`; }
  function formatDate(ts) { if(!ts) return '‚Äî'; const d=ts.toDate?ts.toDate():new Date(ts); return d.toLocaleDateString('pt-BR'); }
  function alertItemHtml(a, showClient=false) {
    const icons = {negativa:'‚ö†Ô∏è',inatividade:'‚è∞',queda:'üìâ',incompleto:'üìã',pergunta:'‚ùì'};
    const colors = {negativa:'red',inatividade:'yellow',queda:'yellow',incompleto:'cyan',pergunta:'cyan'};
    return `<div class="alert-item">
      <div class="alert-icon ${colors[a.tipo]||'cyan'}">${icons[a.tipo]||'üîî'}</div>
      <div class="alert-text"><div class="alert-title">${a.titulo||'Alerta'}</div><div class="alert-desc">${a.descricao||''}${showClient&&a.clienteNome?` ‚Äî <strong>${a.clienteNome}</strong>`:''}</div></div>
      <div class="alert-time">${formatDate(a.data)}</div>
    </div>`;
  }

  document.getElementById('login-password').addEventListener('keydown', e=>{ if(e.key==='Enter') handleLogin(); });
</script>
</body>
</html>
